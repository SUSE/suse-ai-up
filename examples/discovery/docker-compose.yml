version: '3.8'

services:
  # No-Auth MCP Server (High Vulnerability)
  no-auth-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-no-auth-server
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - MCP_TRANSPORT=http
      - PYTHONUNBUFFERED=1
    command: ["python3", "no-auth-server.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/mcp"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mcp-test-network
    restart: unless-stopped

  # Bearer Auth MCP Server (Medium Vulnerability)
  bearer-auth-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-bearer-auth-server
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - MCP_TRANSPORT=http
      - MCP_AUTH_TOKEN=test-bearer-token-12345
      - PYTHONUNBUFFERED=1
    command: ["python3", "bearer-auth-server.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "-H", "Authorization: Bearer test-bearer-token-12345", "http://localhost:8001/mcp"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mcp-test-network
    restart: unless-stopped

  # OAuth Authorization Server
  oauth-auth-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-oauth-auth-server
    ports:
      - "8003:8003"
    environment:
      - OAUTH_PORT=8003
      - OAUTH_TOKEN=oauth-test-token
      - PYTHONUNBUFFERED=1
    command: ["python3", "oauth-server.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/.well-known/oauth-authorization-server"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mcp-test-network
    restart: unless-stopped

  # OAuth MCP Server (Low Vulnerability)
  oauth-mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-oauth-mcp-server
    ports:
      - "8004:8004"
    environment:
      - MCP_PORT=8004
      - MCP_TRANSPORT=http
      - OAUTH_TOKEN=oauth-test-token
      - OAUTH_SERVER_URL=http://oauth-auth-server:8003
      - PYTHONUNBUFFERED=1
    command: ["python3", "oauth-server.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "-H", "Authorization: Bearer oauth-test-token", "http://localhost:8004/mcp"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mcp-test-network
    depends_on:
      oauth-auth-server:
        condition: service_healthy
    restart: unless-stopped

  # Discovery Test Runner (Optional)
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-test-runner
    environment:
      - PROXY_URL=http://host.docker.internal:8911
      - HOST_IP=host.docker.internal
      - PYTHONUNBUFFERED=1
    command: ["tail", "-f", "/dev/null"]  # Keep container running for manual testing
    networks:
      - mcp-test-network
    profiles:
      - testing
    depends_on:
      no-auth-server:
        condition: service_healthy
      bearer-auth-server:
        condition: service_healthy
      oauth-mcp-server:
        condition: service_healthy

networks:
  mcp-test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  logs:
    driver: local